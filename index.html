<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Live Match ‚Äì Export Pro 1024</title>
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <style>
    :root { --stripe-a:#2f7d32; --stripe-b:#256b2b; --overlay: rgba(0,0,0,.24); --evt-sep: rgba(255,255,255,.12); --evt-color:#fff; }
    html, body { max-width:100%; overflow-x:hidden; background:#eaf4ea; -webkit-font-smoothing: antialiased; text-rendering: optimizeLegibility; }
    .evt{ color:var(--evt-color); font-size:14px; line-height:1.15; display:flex; gap:.45rem; align-items:center; }
    .evt .min{ font-family: ui-monospace, SFMono-Regular, Menlo, monospace; opacity:.9; }
    .evt .ico{ width:16px; height:16px; display:inline-flex; align-items:center; justify-content:center; }
    .evt .extra{ opacity:.85; font-size:12px; }
    .evt.muted{ opacity:.85; }
    .col>div{ padding:6px 2px; border-bottom:1px solid var(--evt-sep);}
    .capture{ position:relative; width:100%; aspect-ratio:3/4; overflow:hidden; border-radius:16px; }
    .abs{ position:absolute; inset:0; width:100%; height:100%; }
    .blink{ animation: bl 1s step-start infinite;} @keyframes bl{50%{opacity:.2}}
    .theme-sel { appearance:none; padding:.4rem .6rem; border-radius:.6rem; border:1px solid #e5e7eb; background:#fff; }
    .header-wrap{ padding-top:20px; padding-bottom:16px; }
    .header-bar{ line-height:1.26; align-items:center; min-height:86px; }
    .team-box{ min-width:0; display:flex; align-items:center; gap:.45rem; flex:1; }
    .team-label{
      display:-webkit-box;
      -webkit-line-clamp:2;
      -webkit-box-orient:vertical;
      overflow:hidden;
      white-space:normal;
      word-break:keep-all;
      overflow-wrap:anywhere;
      font-weight:800;
      font-size:1.18rem;
    }
    .team-logo{ width:26px; height:26px; object-fit:contain; }
    .score-wrap{ display:flex; flex-direction:column; align-items:center; justify-content:center; padding:2px 0;}
    #bigScore{ font-weight:900; font-size:2.1rem; letter-spacing:.02em; }
    .export-square{ aspect-ratio: 1/1 !important; width: 1024px !important; height: 1024px !important; border-radius: 24px; }
    .export-square #headWrap { padding-top: 48px !important; padding-bottom: 28px !important; }
    .export-square #headBar { padding: 18px 24px !important; min-height: auto !important; }
    .export-square #bigScore { font-size: 120px !important; }
    .export-square .team-label { font-size: 44px !important; -webkit-line-clamp: 3; }
    .export-square #cols { top: 260px !important; padding: 24px !important; gap: 24px !important; }
    .export-square .evt { font-size: 28px !important; line-height: 1.2 !important; gap: 10px !important; }
    .export-square .evt .ico { width: 28px !important; height: 28px !important; }
    .export-square .evt .extra { font-size: 22px !important; opacity: .9 !important; }
    .export-square .col > div { padding: 10px 0 !important; border-bottom: 2px solid rgba(255,255,255,.18) !important; }
  </style>
</head>
<body class="text-neutral-900">
  <div class="mx-auto p-4 space-y-4 max-w-screen-md">
    <header class="flex items-center justify-between gap-3 flex-wrap">
      <h1 class="text-lg font-bold">Live Match</h1>
      <div class="flex items-center gap-2 text-xs">
        <span id="storageChip" class="px-2 py-1 rounded-full border">Sauvegarde : ‚Ä¶</span>
        <span class="opacity-70">Th√®me</span>
        <select id="themeSel" class="theme-sel">
          <option value="classic">Classic vert</option>
          <option value="night">Nuit</option>
          <option value="retro">R√©tro p√¢le</option>
          <option value="av">AV Bordeaux</option>
          <option value="club">Club (rouge/bleu)</option>
          <option value="rjh">RJH (rouge/bleu)</option>
        </select>
      </div>
    </header>

    <section class="bg-white rounded-2xl shadow p-4 space-y-3">
      <div class="grid sm:grid-cols-2 gap-4">
        <div class="space-y-2">
          <label class="text-sm font-semibold">√âquipe domicile</label>
          <input id="homeName" class="w-full border rounded-lg px-3 py-2" placeholder="Nom de l'√©quipe domicile" />
          <div class="flex items-center gap-3">
            <label class="text-sm">Logo</label>
            <input id="homeLogo" type="file" accept="image/*" class="text-sm" />
          </div>
        </div>
        <div class="space-y-2">
          <label class="text-sm font-semibold">√âquipe visiteur</label>
          <input id="awayName" class="w-full border rounded-lg px-3 py-2" placeholder="Nom de l'√©quipe visiteur" />
          <div class="flex items-center gap-3">
            <label class="text-sm">Logo</label>
            <input id="awayLogo" type="file" accept="image/*" class="text-sm" />
          </div>
        </div>
      </div>

      <div class="grid sm:grid-cols-3 gap-4">
        <div class="space-y-2">
          <label class="text-sm font-semibold">Dur√©e (min)</label>
          <select id="duration" class="w-full border rounded-lg px-3 py-2">
            <option value="90">90</option>
            <option value="120">120 (avec prolongations)</option>
          </select>
        </div>
        <div class="space-y-2">
          <label class="text-sm font-semibold">Horloge</label>
          <div class="flex items-center gap-2 flex-wrap">
            <button id="clockStart" class="px-3 py-2 rounded-lg bg-emerald-600 text-white">‚ñ∂Ô∏è Start</button>
            <button id="clockPause" class="px-3 py-2 rounded-lg bg-amber-600 text-white">‚è∏Ô∏è Pause</button>
            <button id="clockReset" class="px-3 py-2 rounded-lg bg-neutral-200">‚ü≤ Reset</button>
            <span class="ml-auto text-sm font-mono"><span id="clockDisplay">00:00</span></span>
          </div>
        </div>
        <div class="space-y-2">
          <label class="text-sm font-semibold">Filigrane (logo)</label>
          <div class="flex items-center gap-2 flex-wrap">
            <input id="wmFile" type="file" accept="image/*" class="text-sm w-full sm:w-auto" />
            <span class="text-xs">Opacit√©</span>
            <input id="wmOpacity" type="range" min="0" max="1" step="0.05" value="0.18" class="w-32" />
          </div>
        </div>
      </div>

      <div class="flex flex-wrap gap-2 pt-2">
        <button id="newMatch" class="px-3 py-2 rounded-lg bg-neutral-100 border">üÜï Nouveau match</button>
        <button id="resumeMatch" class="px-3 py-2 rounded-lg bg-neutral-100 border">üîÅ Reprendre dernier</button>
        <button id="saveJson" class="px-3 py-2 rounded-lg bg-neutral-100 border">üíæ Sauver (JSON)</button>
        <label for="loadJsonInput" class="px-3 py-2 rounded-lg bg-neutral-100 border cursor-pointer">üì• Charger (JSON)</label>
        <input id="loadJsonInput" type="file" accept="application/json" class="hidden" />
        <button id="clearMatch" class="px-3 py-2 rounded-lg bg-red-50 text-red-700 border border-red-200">üóëÔ∏è Reset (tout)</button>
        <button id="exportPng" class="ml-auto px-3 py-2 rounded-lg bg-indigo-600 text-white">üì§ Export PNG (1024√ó1024)</button>
        <button id="finalScore" class="px-3 py-2 rounded-lg bg-sky-600 text-white">üèÅ Annoncer score final</button>
      </div>
    </section>

    <section class="bg-white rounded-2xl shadow p-4 space-y-3">
      <div class="font-semibold text-sm">√âv√©nements rapides</div>
      <div class="grid sm:grid-cols-2 gap-4">
        <div class="space-y-2">
          <div class="text-sm opacity-80">Pour l'√©quipe domicile</div>
          <div class="flex flex-wrap gap-2">
            <button id="btnHomeGoal"   class="px-3 py-2 rounded-lg bg-emerald-600 text-white">‚öΩÔ∏è But</button>
            <button id="btnHomeYellow" class="px-3 py-2 rounded-lg bg-amber-500 text-white">üü® Jaune</button>
            <button id="btnHomeRed"    class="px-3 py-2 rounded-lg bg-red-600 text-white">üü• Rouge</button>
          </div>
        </div>
        <div class="space-y-2">
          <div class="text-sm opacity-80">Pour l'√©quipe visiteur</div>
          <div class="flex flex-wrap gap-2">
            <button id="btnAwayGoal"   class="px-3 py-2 rounded-lg bg-emerald-600 text-white">‚öΩÔ∏è But</button>
            <button id="btnAwayYellow" class="px-3 py-2 rounded-lg bg-amber-500 text-white">üü® Jaune</button>
            <button id="btnAwayRed"    class="px-3 py-2 rounded-lg bg-red-600 text-white">üü• Rouge</button>
          </div>
        </div>
      </div>
      <div class="grid sm:grid-cols-3 gap-4 items-end">
        <div>
          <label class="text-sm font-semibold">Joueur</label>
          <input id="playerInput" class="w-full border rounded-lg px-3 py-2" placeholder="Nom du joueur (optionnel)" />
        </div>
        <div>
          <label class="text-sm font-semibold">Minute (auto si horloge active)</label>
          <input id="minuteInput" type="number" min="0" max="130" class="w-full border rounded-lg px-3 py-2" placeholder="ex: 62" />
        </div>
        <div class="flex gap-2">
          <button id="halfTime" class="px-3 py-2 rounded-lg bg-neutral-200">‚è±Ô∏è Mi-temps</button>
          <button id="resumeTime" class="px-3 py-2 rounded-lg bg-neutral-200">‚ñ∂Ô∏è Reprise</button>
          <button id="undoEvt" class="px-3 py-2 rounded-lg bg-neutral-100 border">‚Ü©Ô∏è Annuler</button>
        </div>
      </div>
    </section>

    <section id="capture" class="capture shadow-lg">
      <svg class="abs" xmlns="http://www.w3.org/2000/svg" preserveAspectRatio="none">
        <defs>
          <pattern id="stripes" width="1" height="84" patternUnits="userSpaceOnUse">
            <rect x="0" y="0" width="100%" height="42" fill="var(--stripe-a)"/>
            <rect x="0" y="42" width="100%" height="42" fill="var(--stripe-b)"/>
          </pattern>
        </defs>
        <rect x="0" y="0" width="100%" height="100%" fill="url(#stripes)"/>
      </svg>

      <img id="wmImage" alt="filigrane" class="pointer-events-none select-none absolute right-3 bottom-3 w-36 opacity-20" />

      <div id="headWrap" class="absolute left-0 right-0 top-0 px-3 header-wrap">
        <div id="headBar" class="rounded-xl px-3 py-3 text-white flex justify-between gap-3 header-bar" style="background:var(--overlay)">
          <div class="team-box">
            <img id="homeLogoImg" class="team-logo rounded" style="background:transparent" />
            <span id="homeLabel" class="team-label"></span>
          </div>
          <div class="score-wrap">
            <span id="bigScore">0 ‚Äì 0</span>
            <span class="text-[11px] opacity-95 font-mono flex items-center gap-1">
              <span id="dot" class="inline-block w-2 h-2 rounded-full bg-emerald-400"></span>
              <span id="clockDisplayHeader">00:00</span>
            </span>
          </div>
          <div class="team-box justify-end">
            <span id="awayLabel" class="team-label text-right"></span>
            <img id="awayLogoImg" class="team-logo rounded" style="background:transparent" />
          </div>
        </div>
      </div>

      <div id="cols" class="absolute left-0 right-0 bottom-0 p-3 grid grid-cols-2 gap-3" style="top: 126px;">
        <div id="colHome" class="col overflow-y-auto"></div>
        <div id="colAway" class="col overflow-y-auto"></div>
      </div>

      <div id="stateBanner" class="hidden banner-sticky absolute left-1/2 -translate-x-1/2 top-1/2 -translate-y-1/2 bg-white/95 border rounded-xl px-4 py-2 text-lg font-bold">Mi-temps</div>
    </section>

    <footer class="text-xs opacity-70 pb-6">Export Pro 1024 ‚Äî score & √©v√©nements XXL pour WhatsApp.</footer>
  </div>

<script>
const KEY = 'liveMatchV26';
function hasStorage(){ try{ const t='__t'+Date.now(); localStorage.setItem(t,'1'); localStorage.removeItem(t); return true; }catch(e){ return false; } }
const HAS_STORAGE = hasStorage();
const $ = id => document.getElementById(id);
function save(obj){ if(HAS_STORAGE){ try{ localStorage.setItem(KEY, JSON.stringify(obj)); }catch(e){} } }
function hardClearStorage(){ if(HAS_STORAGE){ try{ localStorage.removeItem(KEY); }catch(e){} } }
function load(){ if(!HAS_STORAGE) return null; try{ const v=localStorage.getItem(KEY); return v?JSON.parse(v):null; }catch(e){ return null; } }
function setChip(){ const chip=$('storageChip'); chip.textContent = HAS_STORAGE? 'Sauvegarde : activ√©e' : 'Sauvegarde : d√©sactiv√©e'; chip.className = 'px-2 py-1 rounded-full border' + (HAS_STORAGE?'':' bg-red-100 border-red-200 text-red-700'); }
setChip();

const THEMES = {
  classic: { stripeA:'#2f7d32', stripeB:'#256b2b', overlay:'rgba(0,0,0,.24)', evtSep:'rgba(255,255,255,.12)', evtColor:'#fff' },
  night:   { stripeA:'#0e2a47', stripeB:'#0b2138', overlay:'rgba(0,0,0,.30)', evtSep:'rgba(255,255,255,.12)', evtColor:'#eaf2ff' },
  retro:   { stripeA:'#50b765', stripeB:'#3da455', overlay:'rgba(255,255,255,.18)', evtSep:'rgba(255,255,255,.18)', evtColor:'#ffffff' },
  av:      { stripeA:'#7c0026', stripeB:'#5f001d', overlay:'rgba(0,0,0,.18)', evtSep:'rgba(255,255,255,.2)',  evtColor:'#ffffff' },
  club:    { stripeA:'#b30021', stripeB:'#0d47a1', overlay:'rgba(0,0,0,.24)', evtSep:'rgba(255,255,255,.15)', evtColor:'#ffffff' },
  rjh:     { stripeA:'#c8102e', stripeB:'#1147a6', overlay:'rgba(8,20,40,.36)', evtSep:'rgba(255,255,255,.18)', evtColor:'#ffffff' }
};

const defaultState = () => ({
  match: { home:{name:'Domicile',logo:''}, away:{name:'Visiteur',logo:''}, events:[], status:'NOT_STARTED', score:{home:0,away:0}, duration:90, startedAt:null },
  ui: { theme:'rjh' },
  wm: { dataUrl: '', opacity: 0.18 },
  clock: { running:false, startTs:null, elapsed:0 }
});

const state = load() || defaultState();

const els = {
  themeSel: $('themeSel'),
  homeName: $('homeName'), awayName: $('awayName'),
  homeLogo: $('homeLogo'), awayLogo: $('awayLogo'),
  duration: $('duration'),
  clockStart: $('clockStart'), clockPause: $('clockPause'), clockReset: $('clockReset'),
  clockDisplay: $('clockDisplay'), clockDisplayHeader: $('clockDisplayHeader'), dot: $('dot'),
  wmFile: $('wmFile'), wmOpacity: $('wmOpacity'),
  newMatch: $('newMatch'), resumeMatch: $('resumeMatch'), clearMatch: $('clearMatch'),
  saveJson: $('saveJson'), loadJsonInput: $('loadJsonInput'),
  exportPng: $('exportPng'), finalScore: $('finalScore'),
  playerInput: $('playerInput'), minuteInput: $('minuteInput'),
  halfTime: $('halfTime'), resumeTime: $('resumeTime'), undoEvt: $('undoEvt'),
  capture: $('capture'),
  headWrap: $('headWrap'), headBar: $('headBar'), cols: $('cols'),
  homeLogoImg: $('homeLogoImg'), awayLogoImg: $('awayLogoImg'),
  homeLabel: $('homeLabel'), awayLabel: $('awayLabel'),
  bigScore: $('bigScore'),
  colHome: $('colHome'), colAway: $('colAway'),
  stateBanner: $('stateBanner'),
  wmImage: $('wmImage')
};

function uid(){ try{ return crypto.randomUUID(); }catch(e){ return Date.now().toString(36)+Math.random().toString(36).slice(2,8);} }
const iconFor = t => ({GOAL:'‚öΩÔ∏è',YELLOW:'üü®',RED:'üü•',HT:'‚è±Ô∏è',FT:'üèÅ'}[t])||'';
function nowMinute(){ if(!state.clock.running && state.clock.elapsed===0) return null; const base=state.clock.elapsed+(state.clock.running?(Date.now()-state.clock.startTs):0); return Math.floor(base/60000); }
function fmtScore(){ return state.match.score.home + ' ‚Äì ' + state.match.score.away; }

function applyTheme(){
  const t = THEMES[state.ui.theme]||THEMES.rjh;
  document.documentElement.style.setProperty('--stripe-a', t.stripeA);
  document.documentElement.style.setProperty('--stripe-b', t.stripeB);
  document.documentElement.style.setProperty('--overlay', t.overlay);
  document.documentElement.style.setProperty('--evt-sep', t.evtSep);
  document.documentElement.style.setProperty('--evt-color', t.evtColor);
  save(state);
}

function measureHeader(){
  requestAnimationFrame(() => {
    const h = els.headWrap.getBoundingClientRect().height;
    els.cols.style.top = (h + 12) + 'px';
  });
}

function fitTeamLabels(){
  [els.homeLabel, els.awayLabel].forEach(el => {
    el.style.fontSize = '1.18rem';
    for (const step of [1.18,1.12,1.06,1.0,0.95,0.9,0.85,0.8,0.75]) {
      el.style.fontSize = step + 'rem';
      if (el.scrollHeight <= 44 && el.scrollWidth <= el.clientWidth) break;
    }
  });
}

function renderAll(){
  els.homeLabel.textContent = state.match.home.name||'Domicile';
  els.awayLabel.textContent = state.match.away.name||'Visiteur';
  els.bigScore.textContent = fmtScore();
  els.homeLogoImg.src = state.match.home.logo||'';
  els.awayLogoImg.src = state.match.away.logo||'';
  els.wmImage.src = state.wm.dataUrl||'';
  els.wmImage.style.opacity = state.wm.opacity;
  els.colHome.innerHTML=''; els.colAway.innerHTML='';
  state.match.events.forEach(e=>{
    const minute = ((e.type==='FT'||e.type==='HT'))? '' : (typeof e.minute==='number'? (e.minute+"'") : '');
    let extra=''; if(e.type==='GOAL' && e.snapshot) extra=' <span class="extra">(' + e.snapshot.home + '‚Äì' + e.snapshot.away + ')</span>';
    const nL=document.createElement('div'); nL.className='evt';
    const nR=document.createElement('div'); nR.className='evt';
    if(!e.team){ nL.classList.add('muted'); nR.classList.add('muted'); }
    const content = "<span class='min'>"+minute+"</span> <span class='ico'>"+iconFor(e.type)+"</span> <span class='who font-semibold'>"+(e.player||'')+"</span>"+extra;
    nL.innerHTML=content; nR.innerHTML=content;
    if(e.team==='HOME') els.colHome.appendChild(nL);
    else if(e.team==='AWAY') els.colAway.appendChild(nR);
    else { els.colHome.appendChild(nL); els.colAway.appendChild(nR); }
  });
  fitTeamLabels();
  measureHeader();
}

function pushEvent(evt){
  state.match.events.push(evt);
  if(evt.type==='GOAL'){ if(evt.team==='HOME') state.match.score.home++; if(evt.team==='AWAY') state.match.score.away++; evt.snapshot={...state.match.score}; }
  save(state); renderAll();
}
function undo(){ if(!state.match.events.length) return; state.match.events.pop(); save(state); renderAll(); }

(function tick(){
  const ms=state.clock.elapsed+(state.clock.running?(Date.now()-state.clock.startTs):0);
  const m=Math.floor(ms/60000), s=Math.floor((ms%60000)/1000);
  const v=(m<10?'0':'')+m+':' + (s<10?'0':'')+s;
  els.clockDisplay.textContent=v; els.clockDisplayHeader.textContent=v;
  els.dot.classList.toggle('blink', state.clock.running);
  requestAnimationFrame(tick);
})();

function safe(fn){ return (ev)=>{ ev&&ev.preventDefault&&ev.preventDefault(); try{ fn(); }catch(e){ alert('Erreur: '+e.message); } }; }
els.themeSel.onchange = (e)=>{ state.ui.theme=e.target.value; applyTheme(); };

els.homeName.oninput = (e)=>{ state.match.home.name=e.target.value; save(state); renderAll(); };
els.awayName.oninput = (e)=>{ state.match.away.name=e.target.value; save(state); renderAll(); };
els.duration.onchange = (e)=>{ state.match.duration=Number(e.target.value); save(state); };
els.homeLogo.onchange = (e)=>{ const f=e.target.files && e.target.files[0]; if(!f) return; const r=new FileReader(); r.onload=()=>{ state.match.home.logo=r.result; save(state); renderAll(); }; r.readAsDataURL(f); };
els.awayLogo.onchange = (e)=>{ const f=e.target.files && e.target.files[0]; if(!f) return; const r=new FileReader(); r.onload=()=>{ state.match.away.logo=r.result; save(state); renderAll(); }; r.readAsDataURL(f); };
els.wmFile.onchange   = (e)=>{ const f=e.target.files && e.target.files[0]; if(!f) return; const r=new FileReader(); r.onload=()=>{ state.wm.dataUrl=r.result; save(state); renderAll(); }; r.readAsDataURL(f); };
els.wmOpacity.oninput = (e)=>{ state.wm.opacity=Number(e.target.value); save(state); renderAll(); };

els.clockStart.onclick = safe(()=>{ if(!state.clock.running){ state.clock.running=true; state.clock.startTs=Date.now(); } state.match.status='LIVE'; save(state); });
els.clockPause.onclick = safe(()=>{ if(state.clock.running){ state.clock.elapsed += Date.now()-state.clock.startTs; state.clock.running=false; } save(state); });
els.clockReset.onclick = safe(()=>{ state.clock.running=false; state.clock.elapsed=0; state.clock.startTs=null; save(state); });

function addEvt(team,type){
  let minute = parseInt(els.minuteInput.value,10);
  if(isNaN(minute)){ const m=nowMinute(); minute = (m==null?0:m); }
  const player = (els.playerInput.value||'').trim();
  pushEvent({ id: uid(), minute, team, type, player });
  els.playerInput.value=''; els.minuteInput.value='';
}
$('btnHomeGoal').onclick   = safe(()=>addEvt('HOME','GOAL'));
$('btnHomeYellow').onclick = safe(()=>addEvt('HOME','YELLOW'));
$('btnHomeRed').onclick    = safe(()=>addEvt('HOME','RED'));
$('btnAwayGoal').onclick   = safe(()=>addEvt('AWAY','GOAL'));
$('btnAwayYellow').onclick = safe(()=>addEvt('AWAY','YELLOW'));
$('btnAwayRed').onclick    = safe(()=>addEvt('AWAY','RED'));

$('halfTime').onclick = safe(()=>{
  if(state.match.events.some(e=>e.type==='HT')){ $('stateBanner').textContent='Mi-temps (d√©j√† ajout√©)'; $('stateBanner').classList.remove('hidden'); return; }
  const minute=nowMinute() ?? 45;
  if(state.clock.running){ state.clock.elapsed += Date.now()-state.clock.startTs; }
  state.clock.running = false;
  pushEvent({ id: uid(), minute, team:null, type:'HT', player:'Mi-temps' });
  state.match.status='HT'; save(state);
  $('stateBanner').textContent='Mi-temps'; $('stateBanner').classList.remove('hidden');
});
$('resumeTime').onclick = safe(()=>{
  if(!state.clock.running){ state.clock.running=true; state.clock.startTs=Date.now(); }
  state.match.status='LIVE'; save(state);
  $('stateBanner').classList.add('hidden');
});

$('stateBanner').onclick = ()=> $('stateBanner').classList.add('hidden');
$('undoEvt').onclick = safe(()=>undo());

$('finalScore').onclick = safe(()=>{
  if(state.match.events.some(e=>e.type==='FT')){ $('stateBanner').textContent='Fin de match (d√©j√† ajout√©)'; $('stateBanner').classList.remove('hidden'); return; }
  const minute = nowMinute() ?? state.match.duration;
  pushEvent({ id: uid(), minute, team:null, type:'FT', player:'Fin de match' });
  state.match.status='FT'; save(state);
  $('stateBanner').textContent='FIN ‚Ä¢ ' + fmtScore(); $('stateBanner').classList.remove('hidden');
});

$('newMatch').onclick = safe(()=>{
  state.match.events = [];
  state.match.score = {home:0, away:0};
  state.match.status='NOT_STARTED';
  state.clock = { running:false, startTs:null, elapsed:0 };
  save(state); renderAll();
});

$('resumeMatch').onclick = safe(()=>{
  const s = load();
  if(s){ Object.assign(state, s); applyTheme(); renderAll(); }
  else { $('stateBanner').textContent='Aucune sauvegarde trouv√©e'; $('stateBanner').classList.remove('hidden'); }
});

$('clearMatch').onclick = safe(()=>{
  hardClearStorage();
  const keptTheme = state.ui.theme;
  Object.assign(state, defaultState());
  state.ui.theme = keptTheme;
  save(state); renderAll();
  $('stateBanner').textContent='R√©initialis√©'; $('stateBanner').classList.remove('hidden');
});

async function raf(){ return new Promise(r=>requestAnimationFrame(()=>r())); }

async function exportPNG(){
  window.scrollTo(0,0);
  const cap = $('capture');
  cap.classList.add('export-square');
  const dot = $('dot');
  const l = $('homeLabel'), r = $('awayLabel');
  const backup = {
    dot: dot.style.display,
    l: {display:l.style.display, overflow:l.style.overflow, clamp:l.style.webkitLineClamp},
    r: {display:r.style.display, overflow:r.style.overflow, clamp:r.style.webkitLineClamp}
  };
  dot.style.display='none';
  [l,r].forEach(el=>{ el.style.display='block'; el.style.overflow='visible'; el.style.webkitLineClamp='unset'; });
  await raf(); await raf();
  const raw = await html2canvas(cap, {
    backgroundColor: getComputedStyle(document.documentElement).getPropertyValue('--stripe-a').trim() || '#2f7d32',
    scale: Math.max(2, window.devicePixelRatio || 2),
    useCORS: true
  });
  const out = document.createElement('canvas');
  out.width = 1024; out.height = 1024;
  const ctx = out.getContext('2d');
  ctx.imageSmoothingEnabled = true;
  ctx.imageSmoothingQuality = 'high';
  ctx.drawImage(raw, 0, 0, out.width, out.height);
  dot.style.display = backup.dot || '';
  l.style.display = backup.l.display; l.style.overflow = backup.l.overflow; l.style.webkitLineClamp = backup.l.clamp;
  r.style.display = backup.r.display; r.style.overflow = backup.r.overflow; r.style.webkitLineClamp = backup.r.clamp;
  cap.classList.remove('export-square');
  out.toBlob((blob)=>{
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'match-1024.png';
    a.click();
    setTimeout(()=>URL.revokeObjectURL(a.href), 1000);
  }, 'image/png');
}
$('exportPng').onclick = (e)=>{ e.preventDefault(); exportPNG(); };

function init(){
  applyTheme(); renderAll();
  document.getElementById('themeSel').value = state.ui.theme || 'rjh';
}
init();
window.addEventListener('resize', ()=>{ fitTeamLabels(); measureHeader(); });
</script>
</body>
</html>
